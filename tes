<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cacing Arena">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <title>Cacing Arena Pro - Mabar LAN</title>
    
    <!-- INLINE CSS untuk PWA Install Button -->
    <style>
        #install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(168,85,247,0.4);
            display: none;
        }
        
        #install-button:hover {
            transform: scale(1.05);
        }
    </style>
    
    <!-- KODE CSS GAME ANDA YANG SUDAH ADA -->
    <style>
        /* RESET DAN ORIENTASI LANDSCAPE */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ... SEMUA KODE CSS GAME ANDA YANG LAIN ... */
    </style>
</head>
<body>
    <!-- ... SEMUA HTML GAME ANDA YANG SUDAH ADA ... -->
    
    <!-- PESAN ORIENTASI -->
    <div id="orientation-message">
        <div style="padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 20px;">ðŸ”„</div>
            <h2>Putar HP ke Posisi Landscape!</h2>
            <p style="margin-top: 20px; color: #aaa;">Game ini dirancang untuk dimainkan dalam mode landscape</p>
        </div>
    </div>
    
    <!-- LOADING -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Game...</p>
    </div>
    
    <!-- CANVAS GAME -->
    <canvas id="game"></canvas>
    
    <!-- EFFECT TRANSISI WARNA -->
    <div id="color-transition" class="color-transition"></div>
    
    <!-- UI MENU -->
    <div id="ui-layer">
        <div class="panel">
            <h1>ðŸ”« CACING MABAR</h1>
            <input type="text" id="nick" placeholder="Nama Player" value="Player" maxlength="12">
            <button class="btn btn-play" onclick="Game.startSolo()">ðŸŽ® MAIN SOLO</button>
            <button class="btn btn-mabar" onclick="Room.show()">ðŸ‘¥ MABAR LAN</button>
            
            <!-- TAMBAH TOMBOL INSTALL DI MENU -->
            <button id="menu-install-btn" class="btn" 
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); margin-top: 10px;"
                    onclick="showInstallGuide()">
                ðŸ“² INSTALL APP
            </button>
            
            <div style="margin-top: min(4vw, 20px); color: #f59e0b; font-size: min(3.5vw, 14px); text-align: left; padding: 0 min(2vw, 10px);">
                <div>ðŸŽ¯ Makan makanan untuk skor & peluru</div>
                <div>ðŸ”« Tekan tombol TEMBAK untuk serang</div>
                <div>ðŸ‘¥ Mabar dengan teman 1 WiFi</div>
                <div>ðŸŒˆ Warna berubah setiap 20.000 skor</div>
            </div>
        </div>
    </div>
    
    <!-- ... SEMUA HTML LAINNYA ... -->
    
    <!-- INSTALL BUTTON (Akan muncul otomatis) -->
    <button id="install-button">ðŸ“² INSTALL GAME</button>

    <!-- PEERJS SCRIPT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

    <script>
        // ==================== KODE GAME ANDA YANG SUDAH ADA ====================
        // ... SEMUA KODE GAME ANDA ...
        // ... CONFIG, SpeechAudio, GameState, Projectile, Particle, RainbowSnake, Game, Room, Chat ...
        // ... semua fungsi helper: showMessage, showDamagePopup, checkColorLevelUp, dll ...
        // ... semua fungsi control: shoot, activateSpeed, activateMagnet, pauseGame ...
        // ... semua fungsi init: createAudioButton, setupKeyboardControls, setupTouchControls ...
        
        // ==================== SIMPLE PWA SETUP ====================
        let deferredPrompt;
        
        // 1. Setup Install Button
        const installButton = document.getElementById('install-button');
        
        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    showInstallGuide();
                    return;
                }
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                installButton.style.display = 'none';
            });
        }
        
        // 2. Before Install Prompt Event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ðŸš€ beforeinstallprompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            
            // Tampilkan tombol install setelah 5 detik
            setTimeout(() => {
                if (deferredPrompt && installButton) {
                    installButton.style.display = 'block';
                    console.log('ðŸ“² Install button shown');
                }
            }, 5000);
        });
        
        // 3. App Installed Event
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA installed successfully');
            if (installButton) installButton.style.display = 'none';
            showMessage('ðŸŽ‰ Game berhasil diinstall!', 3000);
        });
        
        // 4. Show Install Guide Function
        function showInstallGuide() {
            const guideHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(20,20,40,0.95);
                    padding: 30px;
                    border-radius: 20px;
                    border: 3px solid #a855f7;
                    z-index: 10001;
                    max-width: 400px;
                    text-align: center;
                    backdrop-filter: blur(10px);
                ">
                    <h3 style="color: #a855f7; margin-bottom: 20px;">ðŸ“² Cara Install Game</h3>
                    
                    <div style="text-align: left; margin: 20px 0; font-size: 14px;">
                        <div style="margin: 10px 0; padding: 10px; background: rgba(168,85,247,0.1); border-radius: 10px;">
                            <strong>Chrome/Edge Desktop:</strong><br>
                            Klik icon <span style="color: #a855f7">ðŸ“²</span> di address bar
                        </div>
                        
                        <div style="margin: 10px 0; padding: 10px; background: rgba(168,85,247,0.1); border-radius: 10px;">
                            <strong>Chrome Android:</strong><br>
                            Menu (â‹®) â†’ "Add to Home screen"
                        </div>
                        
                        <div style="margin: 10px 0; padding: 10px; background: rgba(168,85,247,0.1); border-radius: 10px;">
                            <strong>Safari iOS:</strong><br>
                            Klik share (â–¡â†‘) â†’ "Add to Home Screen"
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.remove()" style="
                        padding: 10px 20px;
                        background: #a855f7;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        margin-top: 10px;
                    ">
                        Tutup
                    </button>
                </div>
            `;
            
            const guideDiv = document.createElement('div');
            guideDiv.innerHTML = guideHTML;
            document.body.appendChild(guideDiv);
        }
        
        // 5. Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker sederhana inline
                const swContent = `
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker: Installing...');
                        event.waitUntil(
                            caches.open('cacing-arena-v1').then((cache) => {
                                return cache.addAll([
                                    './',
                                    './index.html'
                                ]);
                            })
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                // Buat blob dan register service worker
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('âœ… Service Worker registered:', registration.scope);
                        URL.revokeObjectURL(swUrl);
                    })
                    .catch(error => {
                        console.log('âŒ Service Worker registration failed:', error);
                        
                        // Coba register dari file jika inline gagal
                        navigator.serviceWorker.register('sw.js')
                            .then(reg => console.log('Service Worker from file:', reg.scope))
                            .catch(err => console.log('Both SW methods failed:', err));
                    });
            });
        }
        
        // 6. Check if PWA is already installed
        function checkPWAStatus() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
            
            if (isStandalone || isFullscreen) {
                console.log('âœ… Running as installed PWA');
                if (installButton) installButton.style.display = 'none';
            }
        }
        
        // 7. Integrasi dengan init function yang sudah ada
        // Simpan function init asli
        const originalInit = window.init || function() {};
        
        // Override init function
        window.init = function() {
            console.log("Initializing game with PWA support...");
            
            // Panggil init asli
            originalInit();
            
            // Check PWA status
            checkPWAStatus();
            
            // Setup canvas resize
            const canvas = document.getElementById('game');
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            // Setup window resize
            window.addEventListener('resize', () => {
                if (canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            });
        };
        
        // ==================== INIT GAME ====================
        // Function init yang sudah Anda miliki
        function init() {
            console.log("Initializing game...");
            
            // Setup canvas
            const canvas = document.getElementById('game');
            resizeCanvas();
            
            // Setup touch controls
            setupTouchControls();
            
            // Create audio system
            window.GameAudio = new SpeechAudio();
            
            // Create audio button
            createAudioButton();
            
            // Setup keyboard controls
            setupKeyboardControls();
            
            // Hide loading setelah 1.5s
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'flex';
                console.log("Game ready!");
                
                // Mainkan suara welcome
                if (window.GameAudio) {
                    setTimeout(() => window.GameAudio.play('welcome'), 500);
                }
            }, 1500);
            
            // Force landscape on mobile
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    console.log("Orientation lock not supported");
                });
            }
        }
        
        // ==================== EXPORT FUNCTIONS ====================
        window.Game = Game;
        window.Room = Room;
        window.Chat = Chat;
        window.shoot = shoot;
        window.activateSpeed = activateSpeed;
        window.activateMagnet = activateMagnet;
        window.pauseGame = pauseGame;
        window.showInstallGuide = showInstallGuide;
        
        // Start the game
        window.addEventListener('load', init);
        
        console.log("ðŸ‘¥ Cacing Mabar Arena PWA Ready!");
    </script>
</body>
</html>